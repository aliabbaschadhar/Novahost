name: Deploy Whole Monorepo

on:
  push: 
    branches: [main]
    paths:
      - "apps/**"
      - "packages/**"
      - "docker/**"
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: api-server
            dockerfile: docker/Dockerfile.api-server
            paths:
              - "apps/api-server/**"
              - "packages/**"

          - name: web
            dockerfile: docker/Dockerfile.web
            paths:
              - "apps/web/**"
              - "packages/**"

          - name: reverse-proxy
            dockerfile: docker/Dockerfile.reverse-proxy
            paths:
              - "apps/reverse-proxy/**"
              - "packages/typescript-config/**"
              - "packages/eslint-config/**"
          
          - name: build-server
            dockerfile: docker/Dockerfile.build-server
            paths:
              - "apps/build-server/**"
  
    steps:
      - name: Checkout the code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # ensures full git commit history is fetched
      
      - name: Login Docker
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PAT }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Detect changed service paths
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            api-server:
              - 'apps/api-server/**'
              - 'packages/**'
            web:
              - 'apps/web/**'
              - 'packages/**'
            reverse-proxy:
              - 'apps/reverse-proxy/**'
              - 'packages/typescript-config/**'
              - 'packages/eslint-config/**'
            build-server:
              - 'apps/build-server/**'

      - name: Build and push Docker image
        if: steps.filter.outputs[matrix.service.name] == 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: aliabbaschadhar003/novahost-${{ matrix.service.name }}:${{ github.sha }}
          build-args: |
            ${{ matrix.service.name == 'web' && format('DATABASE_URL={0}', secrets.DATABASE_URL) || '' }}